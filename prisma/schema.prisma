// FILE: prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // URL kommt √ºber prisma.config.ts / ENV
}

model CommandUsage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  guildId   String?  @db.VarChar(32)
  channelId String?  @db.VarChar(32)
  userId    String?  @db.VarChar(32)

  commandName String
}

enum TrackingStatus {
  NONE
  ALLOWED
  DENIED
}

model UserTrackingConsent {
  id        String         @id @default(cuid())
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  guildId   String         @db.VarChar(32)
  userId    String         @db.VarChar(32)
  status    TrackingStatus
  version   String?        @db.VarChar(32)

  @@unique([guildId, userId])
}

model CommandStatsGuildDaily {
  id          String   @id @default(cuid())
  date        DateTime
  guildId     String   @db.VarChar(32)
  commandName String
  totalCount  Int      @default(0)

  @@unique([date, guildId, commandName], name: "date_guildId_commandName")
}

//
// üîπ NEU: Polls & Games f√ºr Montags-Runde
//

/// Typ der Umfrage ‚Äì aktuell nur "MONTAG"
enum PollType {
  MONTAG
}

/// Master-Tabelle f√ºr Spiele, die in Polls verwendet werden.
model PollGame {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  /// Anzeigename des Spiels, z.B. "Deep Rock Galactic"
  name         String

  /// Ob das Spiel grunds√§tzlich ausw√§hlbar ist
  isActive     Boolean   @default(true)

  /// Ob das Spiel kostenlos ist (F2P)
  isFree       Boolean   @default(false)

  /// Wie viele Spieler sinnvoll mitspielen k√∂nnen (z.B. 4, 8, 16)
  maxPlayers   Int?

  /// Optional: letztes Mal im Poll gewesen / gewonnen, f√ºr sp√§tere Logik
  lastPlayedAt DateTime?

  /// Anzahl der Gewinne √ºber alle Montags-Polls
  winCount     Int       @default(0)

  /// Polls, in denen dieses Spiel als Gewinner eingetragen wurde
  pollsWon     Poll[]    @relation("Poll_WinnerGame")
}

/// Instanzen von nativen Discord-Polls, die wir tracken
model Poll {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  /// Wann der Poll gestartet wurde (separat von createdAt)
  startedAt    DateTime  @default(now())
  endedAt      DateTime?

  guildId      String    @db.VarChar(32)
  channelId    String    @db.VarChar(32)
  messageId    String    @db.VarChar(32)

  /// Art der Umfrage (z.B. Montags-Runde)
  type         PollType

  /// Frage, die im Poll gestellt wird
  question     String

  /// Optional: Gewinner-Spiel
  winnerGameId String?
  winnerGame   PollGame? @relation("Poll_WinnerGame", fields: [winnerGameId], references: [id])

  @@index([guildId, type, endedAt], name: "poll_guild_type_endedAt")
}

/// T√§gliche Aktivit√§t pro User (Messages/Voice) ‚Äì userId nur bei Opt-in.
model UserActivityDaily {
  id           String    @id @default(cuid())
  date         DateTime
  guildId      String?   @db.VarChar(32)
  userId       String?   @db.VarChar(32)
  messageCount Int       @default(0)
  voiceSeconds Int       @default(0)

  @@unique([date, guildId, userId], name: "date_guild_user")
}

/// Profildaten je User (global, nicht guild-spezifisch)
model UserProfile {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String   @unique @db.VarChar(32)
  birthday  DateTime?
}

model Holiday {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Datum des Feiertags (fix oder pro Jahr eingetragen)
  date      DateTime
  name      String
  region    String   @db.VarChar(4) // z.B. DE, BW, BY, BE ...
}
